######################################################################
# Microsoft Visual C++ Makefile for the primesieve console 
# application and the primesieve C++ library
# 
# Author:          Kim Walisch
# Contact:         kim.walisch@gmail.com
# Created:         10 July 2010
# Last modified:   1 October 2012
#
# Project home:    http://primesieve.googlecode.com
######################################################################

CXX      = cl /nologo
CXXFLAGS = /W2 /O2 /EHsc
INCPATH  = /I src\thirdparty
LINK     = link
TARGET   = primesieve
BINDIR   = bin
LIBDIR   = lib
DISTDIR  = dist
EXDIR    = examples

BIN_OBJECTS = \
  $(BINDIR)\PrimeSieve.obj \
  $(BINDIR)\ParallelPrimeSieve.obj \
  $(BINDIR)\SieveOfEratosthenes.obj \
  $(BINDIR)\PrimeNumberFinder.obj \
  $(BINDIR)\PreSieve.obj \
  $(BINDIR)\WheelFactorization.obj \
  $(BINDIR)\EratSmall.obj \
  $(BINDIR)\EratMedium.obj \
  $(BINDIR)\EratBig.obj

LIB_OBJECTS = \
  $(LIBDIR)\PrimeSieve.obj \
  $(LIBDIR)\ParallelPrimeSieve.obj \
  $(LIBDIR)\SieveOfEratosthenes.obj \
  $(LIBDIR)\PrimeNumberFinder.obj \
  $(LIBDIR)\PreSieve.obj \
  $(LIBDIR)\WheelFactorization.obj \
  $(LIBDIR)\EratSmall.obj \
  $(LIBDIR)\EratMedium.obj \
  $(LIBDIR)\EratBig.obj

EXAMPLE_OBJECTS = \
  $(EXDIR)\cancel_prime_generation.obj \
  $(EXDIR)\count_primes.obj \
  $(EXDIR)\flags.obj \
  $(EXDIR)\generate_primes.obj \
  $(EXDIR)\generate_primes_oop.obj \
  $(EXDIR)\parallel_count.obj \
  $(EXDIR)\parallel_sum_primes.obj \
  $(EXDIR)\parallel_sum_primes2.obj \
  $(EXDIR)\primesieve_error.obj \
  $(EXDIR)\print_twins.obj \
  $(EXDIR)\sieve_size.obj \
  $(EXDIR)\timing.obj

SOE_HEADERS = \
  src\soe\bits.h \
  src\soe\config.h \
  src\soe\EratBig.h \
  src\soe\EratMedium.h \
  src\soe\EratSmall.h \
  src\soe\GENERATE.h \
  src\soe\imath.h \
  src\soe\openmp_RAII.h \
  src\soe\ParallelPrimeSieve.h \
  src\soe\popcount.h \
  src\soe\PreSieve.h \
  src\soe\PrimeNumberFinder.h \
  src\soe\PrimeNumberGenerator.h \
  src\soe\PrimeSieve.h \
  src\soe\SieveOfEratosthenes.h \
  src\soe\SieveOfEratosthenes-inline.h \
  src\soe\toString.h \
  src\soe\WheelFactorization.h
  
MAIN_HEADERS = \
  src\parser\ExpressionParser.h \
  src\soe\PrimeSieve.h \
  src\soe\ParallelPrimeSieve.h \
  src\test\test.h

TEST_HEADERS = \
  src\soe\PrimeSieve.h \
  src\soe\ParallelPrimeSieve.h \
  src\test\test.h

#-----------------------------------------------------------------------------
# Add /openmp if MSVC supports OpenMP 3.0 or later
#-----------------------------------------------------------------------------

!IF ([$(CXX) /? 2>&1 | findstr /I "OpenMP" > nul ] == 0) && \
    ([$(CXX) /? 2>&1 | findstr /I /C:"OpenMP 2" > nul ] != 0)
CXXFLAGS = $(CXXFLAGS) /openmp
!ENDIF

#-----------------------------------------------------------------------------
# Add L1_DCACHE_SIZE to CXXFLAGS
#-----------------------------------------------------------------------------

!IFDEF L1_DCACHE_SIZE
CXXFLAGS = $(CXXFLAGS) /DL1_DCACHE_SIZE=$(L1_DCACHE_SIZE)
!ENDIF

#-----------------------------------------------------------------------------
# Build the primesieve console application (read doc/INSTALL)
#-----------------------------------------------------------------------------

bin: bin_dir bin_obj

bin_dir:
	@if not exist $(BINDIR) mkdir $(BINDIR)

bin_obj: $(BIN_OBJECTS) $(BINDIR)\main.obj $(BINDIR)\test.obj
	$(LINK) /OUT:$(BINDIR)\$(TARGET).exe $**

$(BIN_OBJECTS): src\soe\$(@B).cpp $(SOE_HEADERS)
	$(CXX) $(CXXFLAGS) $(INCPATH) /c src\soe\$(@B).cpp /Fo$@

$(BINDIR)\main.obj: src\application\main.cpp $(MAIN_HEADERS)
	$(CXX) $(CXXFLAGS) $(INCPATH) /c src\application\main.cpp /Fo$@

$(BINDIR)\test.obj: src\test\test.cpp $(TEST_HEADERS)
	$(CXX) $(CXXFLAGS) $(INCPATH) /c src\test\test.cpp /Fo$@

#-----------------------------------------------------------------------------
# Build a static primesieve.lib (read doc/LIBPRIMESIEVE)
#-----------------------------------------------------------------------------

lib: lib_dir lib_obj

lib_dir:
	@if not exist $(LIBDIR) mkdir $(LIBDIR)

lib_obj: $(LIB_OBJECTS)
	lib.exe /OUT:$(LIBDIR)\$(TARGET).lib $**

$(LIB_OBJECTS): src\soe\$(@B).cpp $(SOE_HEADERS)
	$(CXX) $(CXXFLAGS) $(INCPATH) /c src\soe\$(@B).cpp /Fo$@

#-----------------------------------------------------------------------------
# Create a primesieve.lib distribution archive (./dist)
#-----------------------------------------------------------------------------

dist: dist_dir
	copy /Y $(LIBDIR)\$(TARGET).lib $(DISTDIR)
	copy /Y src\soe\*PrimeSieve.h $(DISTDIR)\$(TARGET)\soe

dist_dir:
	@if not exist $(DISTDIR)\$(TARGET)\soe mkdir $(DISTDIR)\$(TARGET)\soe

#-----------------------------------------------------------------------------
# Build the example programs (read examples/INSTALL)
#-----------------------------------------------------------------------------

examples: $(EXAMPLE_OBJECTS)

$(EXAMPLE_OBJECTS): $(EXDIR)\$(@B).cpp
	$(CXX) $(CXXFLAGS) $(INCPATH) /I $(DISTDIR) $** /Fo$@ /Fe$(@R).exe /link dist\$(TARGET).lib

#-----------------------------------------------------------------------------
# Common targets (all, clean)
#-----------------------------------------------------------------------------

all: bin lib

clean:
!IF EXIST($(BINDIR))
	del /Q $(BINDIR)\$(TARGET).exe $(BINDIR)\*.obj
!ENDIF
!IF EXIST($(LIBDIR))
	del /Q $(LIBDIR)\$(TARGET).lib $(LIBDIR)\*.obj
!ENDIF
!IF EXIST($(DISTDIR)\$(TARGET).lib)
	del /Q $(DISTDIR)\$(TARGET).lib
!ENDIF
!IF EXIST($(DISTDIR)\$(TARGET))
	rd /Q /S $(DISTDIR)\$(TARGET)
!ENDIF
!IF EXIST($(EXDIR))
	del /Q $(EXDIR)\*.exe $(EXDIR)\*.obj
!ENDIF

#-----------------------------------------------------------------------------
# `nmake -f Makefile.msvc check` runs correctness tests
#-----------------------------------------------------------------------------

check test: bin
	$(BINDIR)\$(TARGET).exe -test

#-----------------------------------------------------------------------------
# Makefile help menu
#-----------------------------------------------------------------------------

help:
	@echo ------------------------------------------------------
	@echo -------------- primesieve build options --------------
	@echo ------------------------------------------------------
	@echo "nmake -f Makefile.msvc                    Build the primesieve application"
	@echo "nmake -f Makefile.msvc L1_DCACHE_SIZE=64  Set CPU L1 data cache, here 64 KB"
	@echo "nmake -f Makefile.msvc check              Test the primesieve binary"
	@echo "nmake -f Makefile.msvc lib                Build a static primesieve.lib"
	@echo "nmake -f Makefile.msvc dist               Create a lib distribution archive"
	@echo "nmake -f Makefile.msvc examples           Build the example programs"
	@echo "nmake -f Makefile.msvc clean              Clean the output directories"
	@echo "nmake -f Makefile.msvc help               Print this help menu"
