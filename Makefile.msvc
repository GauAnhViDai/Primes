##############################################################################
# Microsoft Visual C++ Makefile for primesieve (console version)
#
# Usage: nmake -f Makefile.msvc
# 
# Author:          Kim Walisch
# Contact:         kim.walisch@gmail.com
# Created:         10 July 2010  
# Last modified:   13 January 2011 
#
# Project home:    http://primesieve.googlecode.com
##############################################################################

# Ignore all error return codes
.IGNORE:

TARGET = primesieve
# Sieve of Eratosthenes directory
SRCDIR = src
# Parsifal arithmetic expression evaluator
EVALDIR = thirdparty/eval11
# Main.cpp directory
MAINDIR = console
OUTDIR = out

# Define the C++ compiler & options
CPP      = cl
CPPFLAGS = /O2 /GL /EHsc /W3 /D "NDEBUG" /D "__STDC_CONSTANT_MACROS" /D "__STDC_LIMIT_MACROS"

# Inculde stdint.h (needed prior MSVC 2010)
INCPATH  = -I"thirdparty"

OBJECTS = $(OUTDIR)\EratBig.obj \
  $(OUTDIR)\ResetSieve.obj \
  $(OUTDIR)\EratMedium.obj \
  $(OUTDIR)\SieveOfEratosthenes.obj \
  $(OUTDIR)\PrimeNumberGenerator.obj \
  $(OUTDIR)\PrimeSieve.obj \
  $(OUTDIR)\PrimeNumberFinder.obj \
  $(OUTDIR)\EratSmall.obj \
  $(OUTDIR)\WheelFactorization.obj \
  $(OUTDIR)\evalkern.obj \
  $(OUTDIR)\evalwrap.obj \
  $(OUTDIR)\ArithmeticExpression.obj \
  $(OUTDIR)\test.obj \
  $(OUTDIR)\main.obj
TARGET = $(OUTDIR)\$(TARGET)

all : create_dir build

create_dir :
!if !EXISTS($(OUTDIR))
  mkdir $(OUTDIR)
!endif
 
{$(SRCDIR)\}.cpp.obj:
  $(CPP) $(CPPFLAGS) $(INCPATH) -c $< /Fo$@

# The Parsifal expression evaluator is C code from 1999 so few warnings
# have to be disabled
{$(EVALDIR)\}.c.obj:
  $(CPP) $(CPPFLAGS) /D "_CRT_NONSTDC_NO_DEPRECATE" /D "_CRT_SECURE_NO_WARNINGS" $(INCPATH) -c $< /Fo$@

{$(EVALDIR)\}.cpp.obj:
  $(CPP) $(CPPFLAGS) /D "_SCL_SECURE_NO_WARNINGS" $(INCPATH) -c $< /Fo$@

{$(MAINDIR)\}.cpp.obj:
  $(CPP) $(CPPFLAGS) $(INCPATH) -c $< /Fo$@

build : $(OBJECTS)
  $(CPP) $(CPPFLAGS) /Fe$(TARGET) $(OBJECTS)
  
clean: 
	del $(OBJECTS)
	del $(TARGET).exe
